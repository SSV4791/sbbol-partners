---
kind: ConfigMap
apiVersion: v1
metadata:
  name: cm-app-properties-{{ canary_suffix }}
data:
  application.properties: |-
    server.port=8080
    server.shutdown=graceful

    spring.jpa.properties.hibernate.jdbc.time_zone=UTC
    spring.jpa.properties.hibernate.cache.use_second_level_cache=true
    spring.jpa.properties.hibernate.cache.use_query_cache=true
    spring.jpa.properties.hibernate.cache.region.factory_class=jcache
    spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

    spring.main.banner-mode=off
    spring.application.name={{ os_project.name }}
    spring.liquibase.enabled=false
    spring.profiles.active=default

    server.servlet.encoding.charset=UTF-8
    server.servlet.encoding.force=true
    server.servlet.encoding.enabled=true
    server.tomcat.uri-encoding=UTF-8
    server.max-http-header-size=40000

    management.metrics.tags.application={{ os_project.name }}
    management.metrics.export.prometheus.enabled=true

    management.endpoints.enabled-by-default=true
    management.endpoints.web.exposure.include=health,prometheus
    management.endpoints.web.base-path={{ context_prefix }}actuator
    management.endpoints.jmx.exposure.include=*
    management.endpoint.metrics.enabled=true
    management.endpoint.prometheus.enabled=true
    management.endpoint.health.show-details=always
    management.endpoint.health.cache.time-to-live=60000

    management.endpoint.health.enabled=true
    management.endpoint.health.group.readiness.show-details=always
    management.endpoint.health.group.liveness.include=ping
    management.endpoint.health.group.liveness.show-details=always
    management.health.db.enabled=false

    # Audit
    audit.enabled={{ os_project.audit.enabled | default('false')}}
    audit.time_out={{ os_project.audit.time_out | default('5000')}}
    audit.x-node-id={{ openshift.env }}
    audit.url={% if int_entry.pprb.audit is mapping %}{{ int_entry.pprb.audit.host }}{% else %}{{ int_entry.pprb.audit | map(attribute='host') | first }}{% endif %}:{% if int_entry.pprb.audit is mapping %}{{ int_entry.pprb.audit.istio_mesh_port }}{% else %}{{ int_entry.pprb.audit | map(attribute='istio_mesh_port') | first | default('80') }}{% endif %}

    # Sbbol connect
    sbbol.url={% if int_entry.sbbol.rest_in is mapping %}{{ int_entry.sbbol.rest_in.host }}{% else %}{{ int_entry.sbbol.rest_in | map(attribute='host') | first }}{% endif %}:{% if int_entry.sbbol.rest_in is mapping %}{{ int_entry.sbbol.rest_in.istio_mesh_port | default('80') }}{% else %}{{ int_entry.sbbol.rest_in | map(attribute='istio_mesh_port') | first | default('80') }}{% endif %}/ss-rest/api
    sbbol.time_out={{ os_project.sbbol.time_out | default('5000') }}

    # Application Journal
    appjournal.moduleId=pprb4-digital-partners

    #StandIn plugin
    standin.plugin.configuration.journalHashKeyResolver={{ standin.plugin.configuration.journalHashKeyResolver | default('INTERFACE')}}
    standin.plugin.configuration.replicationStrategy={{ standin.plugin.configuration.replicationStrategy | default('STANDIN_LOCKS')}}
    standin.plugin.configuration.serializerType={{ standin.plugin.configuration.serializerType | default('BINARY_KRYO')}}
    standin.plugin.configuration.partitionLockMode={{ standin.plugin.configuration.partitionLockMode | default('NONE')}}
    standin.plugin.configuration.orderingControlStrategy={{ standin.plugin.configuration.orderingControlStrategy | default('OPTIMISTIC_LOCK_VERSION_CONTROL')}}
    standin.plugin.configuration.partitionMultiplyingMode={{ standin.plugin.configuration.partitionMultiplyingMode | default('FORBIDDEN')}}

    standin.cloud.client.heartBeatPeriod=1000
    standin.cloud.client.subscriptionKafkaConcurrency=10
    standin.cloud.client.groupId=group_1
    standin.cloud.client.kafka-retry=10
    standin.cloud.client.retry-timeout=10000
    standin.cloud.client.zoneId={{ appjournal_zone_id }}
    standin.cloud.client.kafka.producerConfig."[max.request.size]"=4500000
    standin.cloud.client.kafka.producerConfig."[security.protocol]"=SSL
    standin.cloud.client.kafka.producerConfig."[ssl.keystore.location]"=/opt/keystore/kafka/server.keystore.jks
    standin.cloud.client.kafka.producerConfig."[ssl.truststore.location]"=/opt/keystore/kafka/trust.jks
    standin.cloud.client.kafka.producerConfig."[ssl.keystore.type]"=JKS
    standin.cloud.client.kafka.producerConfig."[ssl.truststore.type]"=JKS
    standin.cloud.client.kafka.producerConfig."[ssl.protocol]"=TLS
    standin.cloud.client.kafka.producerConfig."[ssl.enabled.protocols]"=TLSv1.2
    standin.cloud.client.kafka.producerConfig."[ssl.endpoint.identification.algorithm]"=
    standin.cloud.client.kafka.consumerConfig."[security.protocol]"=SSL
    standin.cloud.client.kafka.consumerConfig."[ssl.keystore.location]"=/opt/keystore/kafka/server.keystore.jks
    standin.cloud.client.kafka.consumerConfig."[ssl.truststore.location]"=/opt/keystore/kafka/trust.jks
    standin.cloud.client.kafka.consumerConfig."[ssl.keystore.type]"=JKS
    standin.cloud.client.kafka.consumerConfig."[ssl.truststore.type]"=JKS
    standin.cloud.client.kafka.consumerConfig."[ssl.protocol]"=TLS
    standin.cloud.client.kafka.consumerConfig."[ssl.enabled.protocols]"=TLSv1.2
    standin.cloud.client.kafka.consumerConfig."[ssl.endpoint.identification.algorithm]"=

{% for entry in integration_entries | flatten %}
{% if entry.ci is defined and entry.health_path is defined %}
    health.http.endpoint[{{ entry.ci }}_{{ entry.name }}].url=http://{{ entry.host }}{{ ':' ~ entry.istio_mesh_port if entry.istio_mesh_port is defined }}{{ entry.health_path }}
{% endif %}
{% endfor %}
  jvm-arguments: |-
