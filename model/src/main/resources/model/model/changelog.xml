<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   logicalFilePath="./partners/changelog.xml">
    <changeSet author="partners" id="1.0.0-before">
        <tagDatabase tag="partners-1.0.0-before"/>
    </changeSet>
    <changeSet author="partners" id="1.0.0-6901271160287920130">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="T_RENTER"/>
            </not>
        </preConditions>
        <createTable
                tablespace="${tablespace_t}"
                tableName="T_RENTER"
                remarks="Code: Renter&#10;Name: Арендатор">

            <column name="INN" type="VARCHAR(254)" remarks="Code: inn&#10;Name: ИНН" ></column>
            <column name="OBJECT_ID" type="VARCHAR(254)" remarks="Code: objectId&#10;Name: Прикладной ID объекта" ><constraints nullable="false"/></column>
            <column name="TYPE" type="VARCHAR(254)" remarks="Code: type&#10;Name: Дискриминатор классов" ><constraints nullable="false"/></column>
            <column name="SYS_ISDELETED" type="${type_boolean}" remarks="Code: isDeleted&#10;Name: System attribute: Deleted flag" defaultValueNumeric="0"><constraints nullable="false"/></column>
            <column name="SYS_LASTCHANGEDATE" type="TIMESTAMP(3)" remarks="Code: lastChangeDate&#10;Name: System attribute: date of the last modification" ></column>
            <column name="SYS_PARTITIONID" type="${type_int}" remarks="Code: partitionId&#10;Name: System attribute: partitioning id" defaultValueNumeric="0"></column>
            <column name="SYS_OWNERID" type="VARCHAR(254)" remarks="Code: ownerId&#10;Name: System attribute: record owner module id" ></column>
            <column name="SYS_RECMODELVERSION" type="VARCHAR(254)" remarks="Code: recModelVersion&#10;Name: System attribute: Record model version" ></column>
            <column name="CHGCNT" type="${type_long}" remarks="Code: chgCnt&#10;Name: Счетчик изменений (технический)" ></column>
            <column name="OFFFLAG" type="${type_byte}" remarks="Code: offFlag&#10;Name: Признак деактивации записи" ></column>
        </createTable>
    </changeSet>

    <changeSet author="partners" id="1.0.0-6901271160287920130-pk">
        <preConditions onFail="MARK_RAN">
            <or>
                <and><dbms type="h2"/><sqlCheck expectedResult="0">SELECT count(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_TYPE = 'PRIMARY KEY' and TABLE_NAME = 'T_RENTER'</sqlCheck></and>
                <and><dbms type="postgresql"/><sqlCheck expectedResult="0">SELECT count(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_TYPE = 'PRIMARY KEY' and TABLE_NAME = lower('T_RENTER')</sqlCheck></and>
                <and><dbms type="oracle"/><sqlCheck expectedResult="0">SELECT count(*) FROM sys.user_constraints where CONSTRAINT_TYPE = 'P' and TABLE_NAME = 'T_RENTER'</sqlCheck></and>
            </or>
        </preConditions>
        <addPrimaryKey tablespace="${tablespace_i}" tableName="T_RENTER" columnNames="OBJECT_ID" constraintName="PK_T_RENTER"/>
    </changeSet>
    <changeSet failOnError="false" author="partners" id="1.0.0-6901271160287920130-index-1">
        <createIndex
            tablespace="${tablespace_i}"
            tableName="T_RENTER"
            unique="false"
            indexName="I_RENTER_TYPE">
            <column name="TYPE"/>
        </createIndex>
    </changeSet>
    <changeSet author="partners" id="1.0.0-6901271160287920131">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="T_RENTERAPICALL"/>
            </not>
        </preConditions>
        <createTable
                tablespace="${tablespace_t}"
                tableName="T_RENTERAPICALL"
                remarks="Code: RenterApiCall&#10;Name: Результат обработки пакета Unit of Work дляRenter">

            <column name="APICALLID" type="VARCHAR(254)" remarks="Code: apiCallId&#10;Name: Идентификатор пакета" ></column>
            <column name="FIRSTCALLDATE" type="TIMESTAMP(3)" remarks="Code: firstCallDate&#10;Name: Дата первого успешного вызова пакета" ></column>
            <column name="DATA" type="VARCHAR(4000)" remarks="Code: data&#10;Name: Результат обработки пакета" ></column>
            <column name="BIGDATA" type="CLOB" remarks="Code: bigData&#10;Name: Результат обработки пакета, используется если результат не помещается в поле data" ></column>
            <column name="PARENTOBJECT_ID" type="VARCHAR(254)" remarks="Code: parentObject&#10;Name: Ссылка на родительский объект" ><constraints nullable="false"/></column>
            <column name="OBJECT_ID" type="VARCHAR(254)" remarks="Code: objectId&#10;Name: Прикладной ID объекта" ><constraints nullable="false"/></column>
            <column name="AGGREGATEROOT_ID" type="VARCHAR(254)" remarks="Code: aggregateRoot&#10;Name: ссылка на корень агрегата" ></column>
            <column name="SYS_ISDELETED" type="${type_boolean}" remarks="Code: isDeleted&#10;Name: System attribute: Deleted flag" defaultValueNumeric="0"><constraints nullable="false"/></column>
            <column name="SYS_LASTCHANGEDATE" type="TIMESTAMP(3)" remarks="Code: lastChangeDate&#10;Name: System attribute: date of the last modification" ></column>
            <column name="SYS_PARTITIONID" type="${type_int}" remarks="Code: partitionId&#10;Name: System attribute: partitioning id" defaultValueNumeric="0"></column>
            <column name="SYS_OWNERID" type="VARCHAR(254)" remarks="Code: ownerId&#10;Name: System attribute: record owner module id" ></column>
            <column name="SYS_RECMODELVERSION" type="VARCHAR(254)" remarks="Code: recModelVersion&#10;Name: System attribute: Record model version" ></column>
            <column name="CHGCNT" type="${type_long}" remarks="Code: chgCnt&#10;Name: Счетчик изменений (технический)" ></column>
            <column name="OFFFLAG" type="${type_byte}" remarks="Code: offFlag&#10;Name: Признак деактивации записи" ></column>
        </createTable>
    </changeSet>
    <changeSet author="partners" id="1.0.0-6901271160287920131-lob-4" dbms="oracle">
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <sqlCheck expectedResult="0">select count (*) from T_RENTERAPICALL</sqlCheck>
            <sqlCheck expectedResult="1">select count (*) from sys.all_lobs where owner=USER and table_name=${namecase}('T_RENTERAPICALL') and column_name=${namecase}('BIGDATA') and tablespace_name&lt;&gt;${namecase}('${tablespace_l}')</sqlCheck>
        </preConditions>
        <sql>alter table T_RENTERAPICALL move lob (BIGDATA) store as (tablespace ${tablespace_l})</sql>
        <rollback/>
    </changeSet>

    <changeSet author="partners" id="1.0.0-6901271160287920131-pk">
        <preConditions onFail="MARK_RAN">
            <or>
                <and><dbms type="h2"/><sqlCheck expectedResult="0">SELECT count(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_TYPE = 'PRIMARY KEY' and TABLE_NAME = 'T_RENTERAPICALL'</sqlCheck></and>
                <and><dbms type="postgresql"/><sqlCheck expectedResult="0">SELECT count(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_TYPE = 'PRIMARY KEY' and TABLE_NAME = lower('T_RENTERAPICALL')</sqlCheck></and>
                <and><dbms type="oracle"/><sqlCheck expectedResult="0">SELECT count(*) FROM sys.user_constraints where CONSTRAINT_TYPE = 'P' and TABLE_NAME = 'T_RENTERAPICALL'</sqlCheck></and>
            </or>
        </preConditions>
        <addPrimaryKey tablespace="${tablespace_i}" tableName="T_RENTERAPICALL" columnNames="OBJECT_ID" constraintName="PK_T_RENTERAPICALL"/>
    </changeSet>
    <changeSet failOnError="false" author="partners" id="1.0.0-6901271160287920131-index-1">
        <createIndex
            tablespace="${tablespace_i}"
            tableName="T_RENTERAPICALL"
            unique="false"
            indexName="I_RENTERAPICALL_APICALLID">
            <column name="APICALLID"/>
        </createIndex>
    </changeSet>
    <changeSet failOnError="false" author="partners" id="1.0.0-6901271160287920131-index-2">
        <createIndex
            tablespace="${tablespace_i}"
            tableName="T_RENTERAPICALL"
            unique="false"
            indexName="I_RENTERAPICALL_PARENTOBJECT_ID">
            <column name="PARENTOBJECT_ID"/>
        </createIndex>
    </changeSet>
    <changeSet failOnError="false" author="partners" id="1.0.0-6901271160287920131-index-3">
        <createIndex
            tablespace="${tablespace_i}"
            tableName="T_RENTERAPICALL"
            unique="false"
            indexName="I_RENTERAPICALL_AGGREGATEROOT_ID">
            <column name="AGGREGATEROOT_ID"/>
        </createIndex>
    </changeSet>
   <changeSet author="partners" id="1.0.0-AGGLOCK-20200713-RENTER">
       <preConditions onFail="MARK_RAN">
           <not> <tableExists tableName="T_REPL_AGGLOCK_RENTER"/> </not>
       </preConditions>
       <createTable tableName="T_REPL_AGGLOCK_RENTER">
           <column name="rootid" type="VARCHAR(255)"> <constraints nullable="false" primaryKey="true" primaryKeyName="PK_T_REPL_AGGLOCK_ROOT_ID_RENTER"/> </column>
           <column name="silock" type="${type_long}" defaultValueNumeric="0"> <constraints nullable="false"/> </column>
           <column name="token" type="VARCHAR(255)"/>
           <column name="migrationstatus" type="${type_boolean}" defaultValueNumeric="0"> <constraints nullable="false"/> </column>
           <column name="chgcnt" type="${type_long}"/>
           <column name="sys_lastchangedate" type="datetime(3)"/>
           <column name="version" type="${type_long}"/>
           <column name="guid" type="VARCHAR(255)"/>
       </createTable>
   </changeSet>
   <changeSet author="partners" id="1.0.0-AGGLOCKEVENT-20200805">
       <preConditions onFail="MARK_RAN">
           <not> <tableExists tableName="T_REPL_AGGLOCKEVENT"/> </not>
       </preConditions>
       <createTable tableName="T_REPL_AGGLOCKEVENT">
           <column name="event_id" type="VARCHAR(128)"> <constraints nullable="false" primaryKey="true" primaryKeyName="PK_T_REPL_AGGLOCKEVENT"/> </column>
           <column name="rootclass" type="VARCHAR(255)"> <constraints nullable="false"/> </column>
           <column name="rootid" type="VARCHAR(255)"> <constraints nullable="false"/> </column>
           <column name="sys_lastchangedate" type="datetime(3)"> <constraints nullable="false"/> </column>
           <column name="info" type="VARCHAR(255)"/>
           <column name="gotdata" type="${type_boolean}" defaultValueNumeric="0"> <constraints nullable="false"/> </column>
           <column name="gotulck" type="${type_boolean}" defaultValueNumeric="0"> <constraints nullable="false"/> </column>
           <column name="gotlck" type="${type_boolean}" defaultValueNumeric="0"> <constraints nullable="false"/> </column>
           <column name="idempotence_key" type="VARCHAR(255)"/>
           <column name="version" type="${type_long}"/>
       </createTable>
   </changeSet>
   <changeSet author="partners" id="1.0.0-AGGLOCKEVENT-20200806">
       <preConditions onFail="MARK_RAN">
           <not> <indexExists indexName="T_REPL_AGGLOCKEVENT_IDEMPOTENCE_KEY_INDEX" tableName="T_REPL_AGGLOCKEVENT"/> </not>
       </preConditions>
       <createIndex indexName="T_REPL_AGGLOCKEVENT_IDEMPOTENCE_KEY_INDEX" tableName="T_REPL_AGGLOCKEVENT">
           <column name="idempotence_key"/>
       </createIndex>
   </changeSet>
   <changeSet author="partners" id="1.0.0-AGGLOCKEVENT-20200807">
       <preConditions onFail="MARK_RAN">
           <not> <indexExists indexName="T_REPL_AGGLOCKEVENT_ROOTCLASS_ROOTID_EVENT_ID_INDEX" tableName="T_REPL_AGGLOCKEVENT"/> </not>
       </preConditions>
       <createIndex indexName="T_REPL_AGGLOCKEVENT_ROOTCLASS_ROOTID_EVENT_ID_INDEX" tableName="T_REPL_AGGLOCKEVENT">
           <column name="rootclass"/>
           <column name="rootid"/>
           <column name="event_id"/>
       </createIndex>
   </changeSet>
   <changeSet author="partners" id="1.0.0-AGGLOCKEVENT-20201026">
       <preConditions onFail="MARK_RAN">
           <not> <columnExists columnName="timestamp_" tableName="T_REPL_AGGLOCKEVENT"/> </not>
       </preConditions>
       <addColumn tableName="T_REPL_AGGLOCKEVENT"> <column name="timestamp_" type="datetime(3)"/> </addColumn>
   </changeSet>
    <changeSet author="partners" id="1.0.0-applied">
        <tagDatabase tag="partners-1.0.0-applied"/>
    </changeSet>
    <changeSet author="partners" id="1.1.0-build.1-before">
        <tagDatabase tag="partners-1.1.0-build.1-before"/>
    </changeSet>

    <changeSet author="partners" id="1.1.0-build.1-applied">
        <tagDatabase tag="partners-1.1.0-build.1-applied"/>
    </changeSet>
    <changeSet author="partners" id="1.1.0-build.2-before">
        <tagDatabase tag="partners-1.1.0-build.2-before"/>
    </changeSet>

    <changeSet author="partners" id="1.1.0-build.2-applied">
        <tagDatabase tag="partners-1.1.0-build.2-applied"/>
    </changeSet>
    <changeSet author="partners" id="1.1.0-build.3-before">
        <tagDatabase tag="partners-1.1.0-build.3-before"/>
    </changeSet>

    <changeSet author="partners" id="1.1.0-build.3-applied">
        <tagDatabase tag="partners-1.1.0-build.3-applied"/>
    </changeSet>
    <changeSet author="partners" id="1.1.0-build.4-before">
        <tagDatabase tag="partners-1.1.0-build.4-before"/>
    </changeSet>

    <changeSet author="partners" id="1.1.0-build.4-applied">
        <tagDatabase tag="partners-1.1.0-build.4-applied"/>
    </changeSet>
    <changeSet author="partners" id="1.1.0-build.5-before">
        <tagDatabase tag="partners-1.1.0-build.5-before"/>
    </changeSet>

    <changeSet author="partners" id="1.1.0-build.5-applied">
        <tagDatabase tag="partners-1.1.0-build.5-applied"/>
    </changeSet>
</databaseChangeLog>